<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Criador de Cartas RPG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Adicionando a fonte medieval 'Cinzel' do Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Estilo geral para o tema RPG */
      :root {
        --bg-color-light: #3b2c21;
        --container-bg-light: #e6d3a8;
        --border-color-light: #6a4a2f;
        --text-color-light: #3b2c21;
        --card-bg-light: #f9f0d7;
        --button-bg-light: #8c6a46;
        --button-hover-light: #a5815e;
        --glow-color-light: rgba(255, 255, 200, 0.5);
        --menu-title-bg-light: #5d422a;
        --menu-title-text-light: #e6d3a8;
        --placeholder-color-light: #7c6156;

        --bg-color-dark: #1a1a1a;
        --container-bg-dark: #2c2c2c;
        --border-color-dark: #555555;
        --text-color-dark: #e6d3a8;
        --card-bg-dark: #3a3a3a;
        --button-bg-dark: #6a6a6a;
        --button-hover-dark: #888888;
        --glow-color-dark: rgba(200, 200, 255, 0.5);
        --menu-title-bg-dark: #4a4a4a;
        --menu-title-text-dark: #e6d3a8;
        --placeholder-color-dark: #b8a685;

        --bg-color: var(--bg-color-light);
        --container-bg: var(--container-bg-light);
        --border-color: var(--border-color-light);
        --text-color: var(--text-color-light);
        --card-bg: var(--card-bg-light);
        --button-bg: var(--button-bg-light);
        --button-hover: var(--button-hover-light);
        --glow-color: var(--glow-color-light);
        --menu-title-bg: var(--menu-title-bg-light);
        --menu-title-text: var(--menu-title-text-light);
        --placeholder-color: var(--placeholder-color-light);
      }

      html {
        scroll-behavior: smooth;
      }

      body.dark-theme {
        --bg-color: var(--bg-color-dark);
        --container-bg: var(--container-bg-dark);
        --border-color: var(--border-color-dark);
        --text-color: var(--text-color-dark);
        --card-bg: var(--card-bg-dark);
        --button-bg: var(--button-bg-dark);
        --button-hover: var(--button-hover-dark);
        --glow-color: var(--glow-color-dark);
        --menu-title-bg: var(--menu-title-bg-dark);
        --menu-title-text: var(--menu-title-text-dark);
        --placeholder-color: var(--placeholder-color-dark);
      }

      body {
        font-family: "Cinzel", serif;
        background: linear-gradient(to bottom, var(--bg-color), #2e201a);
        color: var(--text-color);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 1rem;
        transition: background 0.3s ease, color 0.3s ease;
      }

      #app-container {
        width: 95%;
        margin: auto;
        background-color: var(--container-bg);
        border: 5px solid var(--border-color);
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        border-radius: 10px;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .menu-creator,
      .menu-list {
        padding: 1rem;
        background-color: var(--card-bg);
        border: 3px solid var(--border-color);
        border-radius: 8px;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
      }

      .menu-list {
        display: flex;
        flex-direction: column;
        gap: 2rem;
      }

      .search-bar-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background-color: var(--menu-title-bg);
        border: 2px solid var(--border-color);
        border-radius: 5px;
        padding: 0.25rem 0.5rem;
        width: 100%;
      }

      .search-bar-container .search-input {
        flex-grow: 1;
        background: none;
        border: none;
        outline: none;
        font-family: "Cinzel", serif;
        color: var(--menu-title-text);
        padding: 0.25rem;
      }

      .search-bar-container .search-input::placeholder {
        color: var(--menu-title-text);
      }

      .search-bar-container .search-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0.25rem;
        display: flex;
      }
      .search-bar-container .search-btn svg {
        color: var(--menu-title-text);
        transition: color 0.2s;
      }
      .search-bar-container .search-btn:hover svg {
        color: var(--button-hover);
      }

      .search-bar {
        padding: 0.75rem;
        border-radius: 5px;
        border: 2px solid var(--border-color);
        background-color: var(--card-bg);
        color: var(--text-color);
        font-family: "Cinzel", serif;
        width: 100%;
      }

      .btn {
        background-color: var(--button-bg);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 9999px;
        border: none;
        font-weight: bold;
        text-transform: uppercase;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s, background-color 0.2s, box-shadow 0.2s;
        cursor: pointer;
        text-align: center;
      }

      .btn:hover {
        background-color: var(--button-hover);
        transform: translateY(-2px);
        box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
      }

      .input-field {
        padding: 0.75rem;
        border-radius: 5px;
        border: 2px solid var(--border-color);
        background-color: var(--card-bg);
        color: var(--text-color);
        font-family: "Cinzel", serif;
      }

      .input-field::placeholder {
        color: var(--placeholder-color);
        font-weight: normal;
      }

      .card-title-input::placeholder {
        font-weight: normal;
        font-size: 1.1rem;
      }

      .menu-item {
        padding: 1.5rem;
        background-color: var(--card-bg);
        border: 3px solid var(--border-color);
        border-radius: 8px;
        position: relative;
        cursor: grab;
      }

      .menu-item.dragging {
        opacity: 0.5;
      }

      .menu-title-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
        background-color: var(--menu-title-bg);
        color: var(--menu-title-text);
        padding: 0.5rem 1rem;
        border-radius: 5px;
        margin: -1.5rem -1.5rem 1.5rem -1.5rem;
      }

      .card-list-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 1rem;
        max-height: 9999px;
        overflow: hidden;
        transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
      }

      .card-list-container.collapsed {
        max-height: 0;
        opacity: 0;
        margin-top: -1.5rem;
      }

      .card-item {
        background-color: var(--card-bg);
        border: 2px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        gap: 1rem;
        position: relative;
        cursor: grab;
        min-width: 250px;
        max-width: 300px;
        flex-grow: 0;
        transition: opacity 0.2s;
      }

      .card-item.dragging {
        opacity: 0.5;
        transform: scale(1.05);
        transition: transform 0.1s ease-in-out;
      }

      .remove-card-btn-container {
        position: absolute;
        top: 0.25rem;
        right: 0.25rem;
        z-index: 10;
      }

      .card-image-upload {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
      }

      .card-image-preview {
        width: 100%;
        aspect-ratio: 1 / 1;
        background-color: var(--container-bg);
        border: 1px dashed var(--border-color);
        border-radius: 5px;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        flex-direction: column;
        gap: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
      }

      .card-image-preview:hover {
        box-shadow: 0 0 5px var(--border-color);
      }

      .card-image-preview img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }

      .card-image-preview span {
        color: var(--border-color);
        font-size: 0.875rem;
        text-align: center;
      }

      .resizable-textarea {
          resize: vertical;
          min-height: 100px;
          width: 100%;
          font-family: sans-serif;
          padding-right: 1rem;
          padding-bottom: 1rem;
          text-align: justify;
          font-size: 9px;
          background-color: var(--card-bg);
          color: var(--text-color);
          border: 1px solid var(--border-color);
          border-radius: 5px;
      }

      /* Estilização da barra de rolagem para o tema claro */
      .resizable-textarea::-webkit-scrollbar {
          width: 8px;
          height: 8px;
      }

      .resizable-textarea::-webkit-scrollbar-track {
          background: var(--container-bg-light);
          border-radius: 5px;
      }

      .resizable-textarea::-webkit-scrollbar-thumb {
          background: var(--button-bg-light);
          border-radius: 5px;
      }

      .resizable-textarea::-webkit-scrollbar-thumb:hover {
          background: var(--button-hover-light);
      }

      .resizable-textarea::-webkit-scrollbar-corner {
          background: var(--container-bg-light);
      }

      /* Estilização da barra de rolagem para o tema escuro */
      body.dark-theme .resizable-textarea::-webkit-scrollbar-track {
          background: var(--container-bg-dark);
      }

      body.dark-theme .resizable-textarea::-webkit-scrollbar-thumb {
          background: var(--button-bg-dark);
      }

      body.dark-theme .resizable-textarea::-webkit-scrollbar-thumb:hover {
          background: var(--button-hover-dark);
      }

      body.dark-theme .resizable-textarea::-webkit-scrollbar-corner {
          background: var(--container-bg-dark);
      }


      .draggable-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: grab;
        padding: 0.25rem;
      }

      .draggable-item:hover {
        background-color: var(--menu-title-text);
        opacity: 0.5;
        transform: scale(1.01);
        transition: transform 0.2s ease-in-out, opacity 0.2s ease-in-out,
          background-color 0.2s ease-in-out;
      }

      .draggable-item.dragging {
        opacity: 0.5;
        transform: scale(1.05);
        transition: transform 0.1s ease-in-out;
      }

      .drop-placeholder {
        background-color: #a5815e;
        transition: all 0.1s ease-in-out;
        margin: 0.5rem;
        border-radius: 5px;
      }

      .drop-placeholder.vertical {
        height: 2px;
        width: 90%;
      }

      .drop-placeholder.horizontal {
        height: 90%;
        width: 2px;
      }

      .drop-placeholder.menu {
        height: 5px;
        width: 100%;
        margin: 1rem 0;
      }

      .attribute-input-group .attribute-input {
        width: 50%;
        padding: 0.25rem;
        font-size: 0.875rem;
        border: 1px solid var(--border-color);
        cursor: text;
      }
      .attribute-input:first-child {
        font-weight: bold;
        width: 85%;
      }
      .attribute-input:last-child {
        font-weight: 650;
      }

      .attribute-remove-btn {
        background-color: #000;
        color: white;
        padding: 0.08rem;
        border-radius: 9999px;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .attribute-remove-btn:hover {
        background-color: #625a11;
      }
      .attribute-remove-btn.confirm-delete {
        background-color: #ef4444;
      }

      .description-remove-btn {
        background-color: black;
        color: white;
        padding: 0.08rem;
        border-radius: 9999px;
        cursor: pointer;
        transition: background-color 0.2s;
        position: absolute;
        right: 0.25rem;
        top: 0.25rem;
        z-index: 10;
      }
      .description-remove-btn:hover {
        background-color: #625a11;
      }
      .description-remove-btn.confirm-delete {
        background-color: #ef4444;
      }

      .toggle-menu-btn svg {
        transition: transform 0.3s ease;
      }
      .toggle-menu-btn.rotated svg {
        transform: rotate(180deg);
      }

      /* --- Estilos do modal --- */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 50;
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.3s ease, visibility 0.3s ease;
      }

      .modal-overlay.visible {
        visibility: visible;
        opacity: 1;
      }

      .modal-content {
        background-color: var(--container-bg);
        color: var(--text-color);
        padding: 2rem;
        border-radius: 10px;
        border: 5px solid var(--border-color);
        box-shadow: 0 0 25px rgba(0, 0, 0, 0.7);
        max-width: 90%;
        width: 450px;
        text-align: center;
        font-family: "Cinzel", serif;
      }

      .modal-title {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 1rem;
      }

      .modal-warning-icon {
        color: #ef4444;
      }

      .text-background {
        background-color: var(--menu-title-bg);
        color: var(--text-color);
        padding: 2px 5px;
        border-radius: 3px;
        display: inline-block;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 1rem;
      }

      .modal-btn-group {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-top: 2rem;
      }

      .modal-btn {
        padding: 0.75rem 2rem;
        border-radius: 9999px;
        font-weight: bold;
        transition: transform 0.2s, opacity 0.2s, box-shadow 0.2s;
        text-transform: uppercase;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        cursor: pointer;
      }

      .modal-btn.confirm {
        background-color: #ef4444;
        color: white;
      }
      .modal-btn.confirm:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
      }

      .modal-btn.confirm:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .modal-btn.cancel {
        background-color: var(--button-bg);
        color: var(--text-color);
      }
      .modal-btn.cancel:hover {
        background-color: var(--button-hover);
        transform: translateY(-2px);
        box-shadow: 6px 8px rgba(0, 0, 0, 0.3);
      }

      /* --- Estilos do seletor de tema --- */
      .overlay-menu {
        transition: opacity 0.3s ease, visibility 0.3s ease;
      }
      .overlay-menu-content {
        background-color: var(--container-bg);
        color: var(--text-color);
      }
      .overlay-menu-title {
        color: var(--text-color);
      }
      .theme-btn {
        background-color: var(--button-bg);
        color: var(--text-color);
        transition: background-color 0.2s, transform 0.2s;
      }
      .theme-btn:hover {
        background-color: var(--button-hover);
        transform: translateY(-2px);
      }

      /* Botão Voltar ao Topo */
      #back-to-top-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: var(--button-bg);
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: none; /* Começa oculto */
        justify-content: center;
        align-items: center;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s, visibility 0.3s;
        z-index: 100;
      }
      #back-to-top-btn.show {
        display: flex;
        opacity: 1;
      }
    </style>
  </head>
  <body class="light-theme">
    <div id="app-container" class="rounded-lg shadow-xl">
      <!-- Título responsivo com Tailwind CSS -->
      <h1 class="text-center text-2xl sm:text-3xl md:text-4xl font-bold">
        Criador de Cartas RPG
      </h1>

      <!-- Seção de pesquisa -->
      <div class="menu-creator">
        <div class="search-bar-container flex-grow">
          <input
            type="text"
            id="global-search-input"
            placeholder="Pesquisar menus..."
            class="search-input"
          />
          <button class="search-btn" title="Pesquisar">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
              />
            </svg>
          </button>
        </div>
      </div>

      <!-- Seção de criação e Import/Export. As classes do Tailwind garantem a responsividade. -->
      <div
        class="menu-creator flex flex-col md:flex-row items-center gap-4 flex-wrap"
      >
        <input
          type="text"
          id="menu-title-input"
          placeholder="Título do novo menu"
          class="input-field flex-grow w-full md:w-auto"
        />
        <button id="add-menu-btn" class="btn w-full md:w-auto">
          Adicionar Menu
        </button>
        <button id="export-btn" class="btn w-full md:w-auto">
          Exportar Dados
        </button>
        <label for="import-input" class="btn w-full md:w-auto"
          >Importar Dados</label
        >
        <input type="file" id="import-input" class="hidden" accept=".json" />
      </div>

      <!-- Seção para exibir os menus criados -->
      <div id="menu-list" class="menu-list">
        <!-- Menus serão injetados aqui via JavaScript -->
      </div>
    </div>

    <!-- Botão de engrenagem para abrir o menu de configurações -->
    <button
      id="settingsBtn"
      class="fixed top-4 right-4 p-3 bg-gray-800 text-white rounded-full shadow-lg hover:bg-gray-700 transition-colors"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-5 w-5"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
        />
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
        />
      </svg>
    </button>

    <!-- NOVO: Botão Voltar ao Topo -->
    <button id="back-to-top-btn" title="Voltar ao topo">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />
      </svg>
    </button>

    <!-- Menu sobreposto de opções -->
    <div
      id="overlayMenu"
      class="overlay-menu fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center opacity-0 invisible z-40"
    >
      <div
        class="overlay-menu-content p-8 rounded-2xl shadow-xl w-80 transform transition-transform scale-95 md:scale-100"
      >
        <h2 class="overlay-menu-title text-xl font-bold mb-6 text-center">
          Opções
        </h2>
        <div class="space-y-4">
          <button
            id="saveChangesBtn"
            class="theme-btn w-full py-2 px-4 rounded-full font-semibold"
          >
            Salvar Alterações
          </button>
          <hr class="border-gray-500 my-4" />
          <button
            id="lightThemeBtn"
            class="theme-btn w-full py-2 px-4 rounded-full font-semibold"
          >
            Tema Padrão (Claro)
          </button>
          <button
            id="darkThemeBtn"
            class="theme-btn w-full py-2 px-4 rounded-full font-semibold"
          >
            Tema Noturno (Escuro)
          </button>
        </div>
        <button
          id="closeBtn"
          class="mt-8 w-full py-2 px-4 rounded-full font-semibold transition-colors bg-red-500 text-white hover:bg-red-600"
        >
          Fechar
        </button>
      </div>
    </div>

    <!-- Modal de confirmação de exclusão -->
    <div id="confirmation-modal-overlay" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-title">
          <svg
            class="modal-warning-icon h-8 w-8"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M12 9v3.75m-9.303 3.376c-.866 1.5.119 3.375 1.832 3.375h14.48c1.713 0 2.698-1.875 1.832-3.375L13.832 5.756a1.875 1.875 0 00-3.664 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"
            />
          </svg>
          <span>Último Aviso</span>
        </div>
        <p>
          Você tem certeza absoluta que deseja destruir este menu e todas as
          suas cartas? Esta é uma ação **irreversível**.
        </p>

        <div class="flex flex-col items-start gap-2 mt-4">
          <label class="checkbox-group">
            <input type="checkbox" id="confirm-box-1" class="accent-red-500" />
            <span class="text-background"
              >Eu compreendo que o menu será deletado para sempre.</span
            >
          </label>
          <label class="checkbox-group">
            <input type="checkbox" id="confirm-box-2" class="accent-red-500" />
            <span class="text-background"
              >Eu confirmo que desejo apagar todo o conteúdo deste menu.</span
            >
          </label>
        </div>

        <div class="modal-btn-group">
          <button id="cancel-delete-btn" class="modal-btn cancel">
            Cancelar
          </button>
          <button id="confirm-delete-btn" class="modal-btn confirm" disabled>
            Destruir Menu
          </button>
        </div>
      </div>
    </div>

    <!-- Modal de Erro de Armazenamento -->
    <div id="storage-error-modal-overlay" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-title">
          <svg
            class="modal-warning-icon h-8 w-8"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M12 9v3.75m-9.303 3.376c-.866 1.5.119 3.375 1.832 3.375h14.48c1.713 0 2.698-1.875 1.832-3.375L13.832 5.756a1.875 1.875 0 00-3.664 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"
            />
          </svg>
          <span>Erro ao Salvar</span>
        </div>
        <p>
          Não foi possível salvar as alterações. O armazenamento do navegador
          está cheio, provavelmente devido a imagens muito grandes.
        </p>
        <p class="mt-4">
          Para resolver, tente remover cartas com imagens pesadas ou exporte
          seus dados para um arquivo e comece de novo.
        </p>
        <div class="modal-btn-group">
          <button id="close-storage-error-btn" class="modal-btn cancel">
            Entendi
          </button>
        </div>
      </div>
    </div>

    <!-- NOVO: Modal para nome do arquivo de exportação -->
    <div id="export-filename-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h2 class="modal-title">Nome do Arquivo de Exportação</h2>
            <input type="text" id="export-filename-input" class="input-field w-full" placeholder="nome_do_arquivo.json">
            <div class="modal-btn-group">
                <button id="cancel-export-filename-btn" class="modal-btn cancel">Cancelar</button>
                <button id="confirm-export-filename-btn" class="modal-btn confirm bg-green-600">Exportar</button>
            </div>
        </div>
    </div>

    <script>
      const menuListEl = document.getElementById("menu-list");
      const menuTitleInput = document.getElementById("menu-title-input");
      const addMenuBtn = document.getElementById("add-menu-btn");
      const globalSearchInput = document.getElementById("global-search-input");
      const exportBtn = document.getElementById("export-btn");
      const importInput = document.getElementById("import-input");

      // Modais
      const confirmationModalOverlay = document.getElementById("confirmation-modal-overlay");
      const confirmBox1 = document.getElementById("confirm-box-1");
      const confirmBox2 = document.getElementById("confirm-box-2");
      const confirmDeleteBtn = document.getElementById("confirm-delete-btn");
      const cancelDeleteBtn = document.getElementById("cancel-delete-btn");
      let menuIdToDelete = null;

      const storageErrorModalOverlay = document.getElementById("storage-error-modal-overlay");
      const closeStorageErrorBtn = document.getElementById("close-storage-error-btn");

      const exportFilenameModalOverlay = document.getElementById("export-filename-modal-overlay");
      const exportFilenameInput = document.getElementById("export-filename-input");
      const confirmExportFilenameBtn = document.getElementById("confirm-export-filename-btn");
      const cancelExportFilenameBtn = document.getElementById("cancel-export-filename-btn");

      // Configurações e Tema
      const settingsBtn = document.getElementById("settingsBtn");
      const overlayMenu = document.getElementById("overlayMenu");
      const closeBtn = document.getElementById("closeBtn");
      const lightThemeBtn = document.getElementById("lightThemeBtn");
      const darkThemeBtn = document.getElementById("darkThemeBtn");
      const saveChangesBtn = document.getElementById("saveChangesBtn");
      const body = document.body;

      // Botão Voltar ao Topo
      const backToTopBtn = document.getElementById('back-to-top-btn');

      // Estado da aplicação
      let state = { menus: [] };
      let draggedItem = null;
      let dragItemType = null; // 'menu', 'card', ou 'content'
      let placeholder = null;

      // --- Funções de Estado e Renderização ---

      const saveState = () => {
        try {
          localStorage.setItem("rpgCardCreatorState", JSON.stringify(state));
          saveChangesBtn.textContent = "Salvo com Sucesso!";
          saveChangesBtn.style.backgroundColor = "#22c55e";
          setTimeout(() => {
            saveChangesBtn.textContent = "Salvar Alterações";
            saveChangesBtn.style.backgroundColor = "";
          }, 2000);
        } catch (e) {
          if ( e instanceof DOMException && (e.code === 22 || e.code === 1014 || e.name === "QuotaExceededError" || e.name === "NS_ERROR_DOM_QUOTA_REACHED")) {
            console.error("Erro de quota: O armazenamento local está cheio.", e);
            storageErrorModalOverlay.classList.add("visible");
          } else {
            console.error("Erro inesperado ao salvar o estado:", e);
          }
        }
      };

      const loadState = () => {
        const savedState = localStorage.getItem("rpgCardCreatorState");
        if (savedState) {
          state = JSON.parse(savedState);
        }
      };

      const renderApp = () => {
        const globalFilter = globalSearchInput.value;
        const cardFilters = {};
        document.querySelectorAll(".menu-item").forEach((menuEl) => {
          const searchInput = menuEl.querySelector(".search-bar");
          if (searchInput) cardFilters[menuEl.dataset.menuId] = searchInput.value;
        });

        menuListEl.innerHTML = "";
        state.menus.forEach(renderMenu);

        document.querySelectorAll(".menu-item").forEach((menuEl) => {
          const searchInput = menuEl.querySelector(".search-bar");
          if (searchInput) {
            searchInput.value = cardFilters[menuEl.dataset.menuId] || "";
            searchInput.addEventListener("input", () => applyCardFilter(menuEl));
            applyCardFilter(menuEl);
          }
        });

        globalSearchInput.value = globalFilter;
        applyGlobalFilter();
      };

      const renderMenu = (menu) => {
        const menuEl = document.createElement("div");
        menuEl.classList.add("menu-item", "flex", "flex-col", "gap-4", "rounded-lg");
        menuEl.dataset.menuId = menu.id;
        menuEl.setAttribute('draggable', true); // Habilita arrastar menu

        menuEl.innerHTML = `
            <div class="menu-title-container">
                <span class="menu-title-text text-lg md:text-xl font-bold">${menu.title}</span>
                <div class="flex gap-2 items-center flex-wrap">
                    <label class="import-card-btn p-2 rounded-full hover:bg-gray-700 transition-colors cursor-pointer" title="Importar Carta para este Menu">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                        <input type="file" class="hidden" accept=".json" onchange="importSingleCard(event, ${menu.id})">
                    </label>
                    <button class="toggle-menu-btn p-2 rounded-full hover:bg-gray-700 transition-colors ${menu.isCollapsed ? "rotated" : ""}" title="Minimizar/Maximizar">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    <button class="add-card-btn p-2 rounded-full hover:bg-gray-700 transition-colors" title="Adicionar Carta">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                    </button>
                    <button class="remove-menu-btn p-2 rounded-full hover:bg-red-500 transition-colors" title="Clique 5x para remover">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
            </div>
            <input type="text" placeholder="Pesquisar cartas em '${menu.title}'..." class="search-bar mb-4">
            <div class="card-list-container ${menu.isCollapsed ? "collapsed" : ""}"></div>
        `;

        const cardContainer = menuEl.querySelector(".card-list-container");
        menu.cards.forEach((card) => {
          const cardEl = renderCard(card, menu.id);
          cardContainer.appendChild(cardEl);
        });

        menuListEl.appendChild(menuEl);
      };

      const renderCard = (card, menuId) => {
        const cardEl = document.createElement("div");
        cardEl.classList.add("card-item", "rounded-lg");
        cardEl.dataset.cardId = card.id;
        cardEl.setAttribute("draggable", true);

        cardEl.innerHTML = `
            <div class="remove-card-btn-container">
                <button class="remove-card-btn p-1 rounded-full hover:bg-red-500 transition-colors" title="Clique 3x para remover">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <input type="text" value="${card.title}" placeholder="Título da Carta" class="text-xl card-title-input input-field w-full font-bold">
            <div class="card-image-upload">
                <div class="card-image-preview rounded-md mb-2">
                    ${card.image ? `<img src="${card.image}" alt="Imagem da Carta">` : "<span>Clique para carregar imagem</span>"}
                </div>
                <input type="file" class="card-image-file-input hidden" accept="image/*"/>
            </div>
            <div class="flex gap-2 justify-center">
                <button class="add-attribute-btn btn px-1 py-0.5 text-xs">Atributo</button>
                <button class="add-description-btn btn px-1 py-0.5 text-xs">Descrição</button>
                <button class="export-card-btn btn px-1 py-0.5 text-xs" onclick="exportSingleCard(${menuId}, ${card.id})">Exportar</button>
            </div>
            <div class="card-content-container flex flex-col gap-2"></div>
        `;

        const imagePreview = cardEl.querySelector(".card-image-preview");
        const fileInput = cardEl.querySelector(".card-image-file-input");
        imagePreview.addEventListener("click", () => fileInput.click());

        const contentContainer = cardEl.querySelector(".card-content-container");
        card.content.forEach((item) => {
          const contentItemEl = createContentElement(item);
          contentContainer.appendChild(contentItemEl);
        });
        return cardEl;
      };

      const createContentElement = (item) => {
        const contentItemEl = document.createElement("div");
        contentItemEl.classList.add("draggable-item");
        contentItemEl.dataset.contentId = item.id;
        contentItemEl.dataset.contentType = item.type;
        contentItemEl.setAttribute("draggable", true);

        if (item.type === "attribute") {
          contentItemEl.classList.add("attribute-input-group");
          contentItemEl.innerHTML = `
              <input type="text" value="${item.label}" placeholder="Rótulo" class="input-field attribute-input">
              <input type="text" value="${item.value}" placeholder="Valor" class="input-field attribute-input">
              <button class="attribute-remove-btn rounded-full text-white" title="Clique 2x para remover">
                   <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
              </button>
          `;
        } else if (item.type === "description") {
          contentItemEl.classList.add("description-input-group", "relative", "w-full");
          contentItemEl.innerHTML = `
              <textarea class="resizable-textarea input-field" placeholder="Adicione a descrição da carta...">${item.value}</textarea>
              <button class="description-remove-btn rounded-full text-white" title="Remover Descrição">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
              </button>
          `;
        }
        return contentItemEl;
      };

      const addAttributeToCard = (cardEl, card) => {
        const newItem = { id: Date.now(), type: "attribute", label: "", value: "" };
        card.content.push(newItem);
        const contentContainer = cardEl.querySelector(".card-content-container");
        const contentItemEl = createContentElement(newItem);
        contentContainer.appendChild(contentItemEl);
      };

      const addDescriptionToCard = (cardEl, card) => {
        const newItem = { id: Date.now(), type: "description", value: "" };
        card.content.push(newItem);
        const contentContainer = cardEl.querySelector(".card-content-container");
        const contentItemEl = createContentElement(newItem);
        contentContainer.appendChild(contentItemEl);
      };

      // --- Funções de Import/Export ---

      const showExportFilenameModal = () => {
        exportFilenameInput.value = 'rpg_cards_data.json';
        exportFilenameModalOverlay.classList.add('visible');
      };

      const hideExportFilenameModal = () => {
        exportFilenameModalOverlay.classList.remove('visible');
      };

      const exportData = (filename) => {
          const dataStr = JSON.stringify(state, null, 2);
          const dataBlob = new Blob([dataStr], { type: "application/json" });
          const url = URL.createObjectURL(dataBlob);
          const link = document.createElement("a");
          link.href = url;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          hideExportFilenameModal();
      };

      const exportSingleCard = (menuId, cardId) => {
        const menu = state.menus.find(m => m.id === menuId);
        const card = menu?.cards.find(c => c.id === cardId);
        if (!card) return;

        const cardData = JSON.stringify(card, null, 2);
        const dataBlob = new Blob([cardData], { type: "application/json" });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement("a");
        link.href = url;
        const filename = card.title.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'carta_exportada';
        link.download = `${filename}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      };

      const importSingleCard = (event, menuId) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedCard = JSON.parse(e.target.result);
                if (importedCard && importedCard.id && importedCard.content) {
                    const menu = state.menus.find(m => m.id === menuId);
                    if (menu) {
                        // Gera novos IDs para a carta e seu conteúdo para evitar conflitos
                        importedCard.id = Date.now();
                        importedCard.content.forEach(item => {
                            item.id = Date.now() + Math.random();
                        });
                        menu.cards.push(importedCard);
                        renderApp();
                    }
                } else {
                    alert('Arquivo de carta inválido.');
                }
            } catch (error) {
                console.error("Erro ao importar carta:", error);
                alert('Erro ao ler o arquivo da carta.');
            }
        };
        reader.readAsText(file);
        event.target.value = ''; // Limpa o input para permitir reimportar o mesmo arquivo
      };

      // --- Funções de Filtragem e Modal ---
      const applyGlobalFilter = () => {
        const filter = globalSearchInput.value.toLowerCase();
        document.querySelectorAll(".menu-item").forEach((menuEl) => {
          const menuTitle = menuEl.querySelector(".menu-title-text").textContent.toLowerCase();
          menuEl.style.display = menuTitle.includes(filter) ? "flex" : "none";
        });
      };

      const applyCardFilter = (menuEl) => {
        const searchInput = menuEl.querySelector(".search-bar");
        if (!searchInput) return;
        const filter = searchInput.value.toLowerCase();
        const cardContainer = menuEl.querySelector(".card-list-container");
        if (!cardContainer) return;
        cardContainer.querySelectorAll(".card-item").forEach((cardEl) => {
          const cardTitle = cardEl.querySelector(".card-title-input").value.toLowerCase();
          cardEl.style.display = cardTitle.includes(filter) ? "flex" : "none";
        });
      };

      const showConfirmationModal = (menuId) => {
        menuIdToDelete = menuId;
        confirmationModalOverlay.classList.add("visible");
        confirmBox1.checked = false;
        confirmBox2.checked = false;
        confirmDeleteBtn.disabled = true;
      };

      const hideConfirmationModal = () => {
        confirmationModalOverlay.classList.remove("visible");
        menuIdToDelete = null;
      };

      // --- Funções de Drag and Drop ---

      const getPlaceholder = (type) => {
        if (!placeholder) {
          placeholder = document.createElement("div");
          placeholder.classList.add("drop-placeholder");
        }
        placeholder.className = 'drop-placeholder'; // Reseta as classes
        placeholder.classList.add(type);
        return placeholder;
      };

      const getDragAfterElement = (container, clientX, clientY, type) => {
        const selector = `.${type}-item:not(.dragging)`;
        const draggableElements = [...container.querySelectorAll(selector)];

        return draggableElements.reduce(
          (closest, child) => {
            const box = child.getBoundingClientRect();

            if (type === 'card') {
                // Lógica de distância para cards em layout flex-wrap
                const centerX = box.left + box.width / 2;
                const centerY = box.top + box.height / 2;
                const distance = Math.sqrt(Math.pow(centerX - clientX, 2) + Math.pow(centerY - clientY, 2));
                if (distance < closest.distance) {
                    return { distance: distance, element: child };
                } else {
                    return closest;
                }
            } else {
                // Lógica de offset vertical para menus e conteúdo
                const offset = clientY - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                  return { offset: offset, element: child };
                } else {
                  return closest;
                }
            }
          },
          { offset: Number.NEGATIVE_INFINITY, distance: Number.POSITIVE_INFINITY }
        ).element;
      };

      const updateMenuOrder = () => {
        const newMenuOrder = Array.from(menuListEl.querySelectorAll('.menu-item')).map(menuEl => {
            const menuId = parseInt(menuEl.dataset.menuId);
            return state.menus.find(m => m.id === menuId);
        });
        state.menus = newMenuOrder.filter(Boolean);
      };

      const updateCardOrder = (menuEl) => {
        const menuId = parseInt(menuEl.dataset.menuId);
        const menu = state.menus.find((m) => m.id === menuId);
        if (!menu) return;
        const newCardOrder = Array.from(menuEl.querySelectorAll(".card-item")).map((cardEl) => {
          const cardId = parseInt(cardEl.dataset.cardId);
          return menu.cards.find((c) => c.id === cardId);
        });
        menu.cards = newCardOrder.filter(Boolean);
      };

      const updateCardContentOrder = (cardEl) => {
        const cardId = parseInt(cardEl.dataset.cardId);
        const menuEl = cardEl.closest(".menu-item");
        if (!menuEl) return;
        const menuId = parseInt(menuEl.dataset.menuId);
        const menu = state.menus.find((m) => m.id === menuId);
        const card = menu?.cards.find((c) => c.id === cardId);
        if (!card) return;
        const newContentOrder = Array.from(cardEl.querySelectorAll(".draggable-item")).map((itemEl) => {
          const contentId = parseInt(itemEl.dataset.contentId);
          return card.content.find((item) => item.id === contentId);
        });
        card.content = newContentOrder.filter(Boolean);
      };

      // Compressão de imagem
      const compressImage = (file, callback) => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const max = 800;
            let w = img.width, h = img.height;
            if (w > h && w > max) { h *= max / w; w = max; }
            else if (h > max) { w *= max / h; h = max; }
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            callback(canvas.toDataURL('image/jpeg', 0.7));
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      };

      // --- Event Listeners ---

      // Botão Voltar ao Topo
      window.addEventListener('scroll', () => {
        if (window.scrollY > 300) {
            backToTopBtn.classList.add('show');
        } else {
            backToTopBtn.classList.remove('show');
        }
      });
      backToTopBtn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });

      closeStorageErrorBtn.addEventListener("click", () => storageErrorModalOverlay.classList.remove("visible"));

      // CORRIGIDO: Listener do botão de configurações
      settingsBtn.addEventListener("click", () => {
          overlayMenu.classList.toggle("invisible");
          overlayMenu.classList.toggle("opacity-0");
      });
      closeBtn.addEventListener("click", () => {
          overlayMenu.classList.add("invisible");
          overlayMenu.classList.add("opacity-0");
      });

      saveChangesBtn.addEventListener("click", saveState);

      // Listeners do modal de nome de arquivo
      exportBtn.addEventListener('click', showExportFilenameModal);
      cancelExportFilenameBtn.addEventListener('click', hideExportFilenameModal);
      confirmExportFilenameBtn.addEventListener('click', () => {
        const filename = exportFilenameInput.value.trim();
        if (filename) {
            exportData(filename.endsWith('.json') ? filename : `${filename}.json`);
        }
      });

      const applyTheme = (theme) => {
        body.classList.remove("light-theme", "dark-theme");
        body.classList.add(theme + "-theme");
        localStorage.setItem("theme", theme);
      };
      lightThemeBtn.addEventListener("click", () => applyTheme("light"));
      darkThemeBtn.addEventListener("click", () => applyTheme("dark"));

      globalSearchInput.addEventListener("input", applyGlobalFilter);

      addMenuBtn.addEventListener("click", () => {
        const title = menuTitleInput.value.trim();
        if (title) {
          state.menus.push({ id: Date.now(), title: title, isCollapsed: false, cards: [] });
          menuTitleInput.value = "";
          renderApp();
        }
      });

      importInput.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const importedState = JSON.parse(e.target.result);
            if (importedState && Array.isArray(importedState.menus)) {
              state = importedState;
              renderApp();
            } else {
              alert("Arquivo JSON inválido ou com formato incorreto.");
            }
          } catch (error) {
            console.error("Erro ao importar o arquivo:", error);
          }
        };
        reader.readAsText(file);
        event.target.value = "";
      });

      cancelDeleteBtn.addEventListener("click", hideConfirmationModal);
      [confirmBox1, confirmBox2].forEach((checkbox) => {
        checkbox.addEventListener("change", () => {
          confirmDeleteBtn.disabled = !(confirmBox1.checked && confirmBox2.checked);
        });
      });
      confirmDeleteBtn.addEventListener("click", () => {
        if (menuIdToDelete !== null) {
          state.menus = state.menus.filter((m) => m.id !== menuIdToDelete);
          hideConfirmationModal();
          renderApp();
        }
      });

      // Event delegation para Drag and Drop
      document.getElementById('app-container').addEventListener("dragstart", (e) => {
        if (['INPUT', 'TEXTAREA', 'BUTTON', 'LABEL'].includes(e.target.tagName) || e.target.closest('button, label')) {
          e.preventDefault();
          return;
        }

        const menuItem = e.target.closest('.menu-item');
        const cardItem = e.target.closest('.card-item');
        const contentItem = e.target.closest('.draggable-item');

        if (contentItem) {
          draggedItem = contentItem;
          dragItemType = 'content';
        } else if (cardItem) {
          draggedItem = cardItem;
          dragItemType = 'card';
        } else if (menuItem) {
          draggedItem = menuItem;
          dragItemType = 'menu';
        } else {
          return;
        }

        setTimeout(() => draggedItem.classList.add('dragging'), 0);
        e.dataTransfer.effectAllowed = "move";
      });

      document.getElementById('app-container').addEventListener("dragover", (e) => {
        e.preventDefault();
        if (!draggedItem) return;

        let dropContainer, afterElement;

        switch (dragItemType) {
            case 'menu':
                dropContainer = e.target.closest('#menu-list');
                if (!dropContainer) return;
                afterElement = getDragAfterElement(dropContainer, e.clientX, e.clientY, 'menu');
                placeholder = getPlaceholder('menu');
                break;
            case 'card':
                dropContainer = e.target.closest('.card-list-container');
                if (!dropContainer) return;
                afterElement = getDragAfterElement(dropContainer, e.clientX, e.clientY, 'card');
                placeholder = getPlaceholder('horizontal');
                break;
            case 'content':
                dropContainer = e.target.closest('.card-content-container');
                if (!dropContainer) return;
                afterElement = getDragAfterElement(dropContainer, e.clientX, e.clientY, 'draggable');
                placeholder = getPlaceholder('vertical');
                break;
        }

        if (dropContainer) {
            if (afterElement == null) {
                dropContainer.appendChild(placeholder);
            } else {
                dropContainer.insertBefore(placeholder, afterElement);
            }
        }
      });

      document.getElementById('app-container').addEventListener("drop", (e) => {
        e.preventDefault();
        if (!draggedItem) return;

        const existingPlaceholder = document.querySelector('.drop-placeholder');
        if (existingPlaceholder) {
          const dropContainer = existingPlaceholder.parentElement;
          dropContainer.insertBefore(draggedItem, existingPlaceholder);

          switch(dragItemType) {
            case 'menu':
                updateMenuOrder();
                break;
            case 'card':
                updateCardOrder(dropContainer.closest('.menu-item'));
                break;
            case 'content':
                updateCardContentOrder(dropContainer.closest('.card-item'));
                break;
          }
        }

        if (placeholder) placeholder.remove();
        if (draggedItem) draggedItem.classList.remove('dragging');
        draggedItem = null;
        dragItemType = null;
      });

      document.getElementById('app-container').addEventListener("dragend", () => {
        if (draggedItem) draggedItem.classList.remove('dragging');
        if (placeholder) placeholder.remove();
        draggedItem = null;
        dragItemType = null;
      });

      menuListEl.addEventListener("click", (e) => {
        const menuEl = e.target.closest(".menu-item");
        if (!menuEl) return;
        const menuId = parseInt(menuEl.dataset.menuId);
        const menu = state.menus.find((m) => m.id === menuId);
        if (!menu) return;

        if (e.target.closest(".add-card-btn")) {
          menu.cards.push({ id: Date.now(), title: "", image: "", content: [] });
          renderApp();
        }

        const removeMenuBtn = e.target.closest(".remove-menu-btn");
        if (removeMenuBtn) {
          const currentClicks = parseInt(removeMenuBtn.dataset.clickCount || 0) + 1;
          removeMenuBtn.dataset.clickCount = currentClicks;
          if (currentClicks >= 5) {
            showConfirmationModal(menuId);
            removeMenuBtn.dataset.clickCount = 0;
            removeMenuBtn.title = "Clique 5x para remover";
          } else {
            removeMenuBtn.title = `Clique mais ${5 - currentClicks}x para remover`;
          }
        }

        const removeCardBtn = e.target.closest(".remove-card-btn");
        if (removeCardBtn) {
          const currentClicks = parseInt(removeCardBtn.dataset.clickCount || 0) + 1;
          if (currentClicks >= 3) {
            const cardEl = removeCardBtn.closest(".card-item");
            const cardId = parseInt(cardEl.dataset.cardId);
            menu.cards = menu.cards.filter((c) => c.id !== cardId);
            renderApp();
          } else {
            removeCardBtn.dataset.clickCount = currentClicks;
            removeCardBtn.title = `Clique mais ${3 - currentClicks}x para remover`;
          }
        }
        const cardEl = e.target.closest(".card-item");
        if (cardEl) {
          const cardId = parseInt(cardEl.dataset.cardId);
          const card = menu.cards.find((c) => c.id === cardId);
          if (!card) return;
          if (e.target.closest(".add-attribute-btn")) {
            addAttributeToCard(cardEl, card);
          }
          if (e.target.closest(".add-description-btn")) {
            addDescriptionToCard(cardEl, card);
          }
          const removeContentBtn = e.target.closest(".attribute-remove-btn, .description-remove-btn");
          if (removeContentBtn) {
            const contentItemEl = removeContentBtn.closest("[data-content-id]");
            const contentType = contentItemEl.dataset.contentType;
            const contentId = parseInt(contentItemEl.dataset.contentId);
            const clickCountKey = `clickCount_${contentType}`;
            const currentClicks = parseInt(removeContentBtn.dataset[clickCountKey] || 0) + 1;
            if (currentClicks >= 2) {
                card.content = card.content.filter((item) => item.id !== contentId);
                contentItemEl.remove();
            } else {
                removeContentBtn.dataset[clickCountKey] = currentClicks;
                removeContentBtn.classList.add("confirm-delete");
                removeContentBtn.title = "Clique novamente para remover";
            }
          }
        }
        const toggleBtn = e.target.closest(".toggle-menu-btn");
        if (toggleBtn) {
          menu.isCollapsed = !menu.isCollapsed;
          menuEl.querySelector(".card-list-container").classList.toggle("collapsed");
          toggleBtn.classList.toggle("rotated");
        }
      });

      menuListEl.addEventListener("input", (e) => {
        const cardEl = e.target.closest(".card-item");
        const menuEl = e.target.closest(".menu-item");
        if (!cardEl || !menuEl) return;
        const cardId = parseInt(cardEl.dataset.cardId);
        const menuId = parseInt(menuEl.dataset.menuId);
        const menu = state.menus.find((m) => m.id === menuId);
        const card = menu?.cards.find((c) => c.id === cardId);
        if (!card) return;
        if (e.target.classList.contains("card-title-input")) {
          card.title = e.target.value;
        } else {
          const contentItemEl = e.target.closest("[data-content-id]");
          if (contentItemEl) {
            const contentId = parseInt(contentItemEl.dataset.contentId);
            const contentItem = card.content.find((item) => item.id === contentId);
            if (!contentItem) return;
            if (e.target.classList.contains("attribute-input")) {
              const inputs = contentItemEl.querySelectorAll(".attribute-input");
              contentItem.label = inputs[0].value;
              contentItem.value = inputs[1].value;
            } else if (e.target.classList.contains("resizable-textarea")) {
              contentItem.value = e.target.value;
            }
          }
        }
        if (e.target.classList.contains("card-title-input")) applyCardFilter(menuEl);
      });

      menuListEl.addEventListener("change", (e) => {
        if (e.target.classList.contains("card-image-file-input")) {
          const file = e.target.files[0];
          if (!file) return;
          compressImage(file, (compressed) => {
            const cardEl = e.target.closest(".card-item");
            const cardId = parseInt(cardEl.dataset.cardId);
            const menuEl = e.target.closest(".menu-item");
            const menuId = parseInt(menuEl.dataset.menuId);
            const menu = state.menus.find((m) => m.id === menuId);
            const card = menu?.cards.find((c) => c.id === cardId);
            if (card) {
              card.image = compressed;
              let img = cardEl.querySelector(".card-image-preview img");
              const preview = cardEl.querySelector(".card-image-preview");
              if (!img) {
                img = document.createElement("img");
                img.alt = "Imagem da Carta";
                preview.innerHTML = "";
                preview.appendChild(img);
              }
              img.src = compressed;
            }
          });
        }
      });

      window.onload = () => {
        loadState();
        renderApp();
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme) {
          applyTheme(savedTheme);
        }
      };
    </script>
  </body>
</html>